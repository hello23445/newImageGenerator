<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Подключение почты</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{
  margin:0;width:100%;height:100%;
  font-family:Inter,system-ui,sans-serif;
  background:
    radial-gradient(700px 400px at 20% 0%, rgba(56,189,248,.25), transparent 60%),
    radial-gradient(700px 400px at 80% 10%, rgba(168,85,247,.25), transparent 60%),
    linear-gradient(180deg,#020617,#020617);
  display:flex;align-items:center;justify-content:center;
  color:#fff;
}
.card{
  width:100%;max-width:400px;padding:22px;
  border-radius:22px;
  background:rgba(255,255,255,.08);
  backdrop-filter:blur(14px);
  box-shadow:0 20px 60px rgba(0,0,0,.4);
  text-align:center;
}
.back-btn{
  width:100%;
  background:#251897;
  color:#fff;
  border-radius:14px;
  padding:12px;
  font-size:14px;
  font-weight:500;
  margin-bottom:16px;
  cursor:pointer;
}
h2{margin:0 0 6px;font-weight:600}
.subtitle{font-size:14px;opacity:.7;margin-bottom:18px}
input{
  width:100%;padding:14px 16px;
  border-radius:14px;border:none;outline:none;
  background:rgba(255,255,255,.15);
  color:#fff;font-size:15px;
}
button{
  width:100%;margin-top:14px;padding:14px;
  border-radius:999px;border:none;
  background:linear-gradient(135deg,#2563eb,#4f46e5);
  color:#fff;font-size:15px;font-weight:600;
  cursor:pointer;
}
button.secondary{background:rgba(255,255,255,.15)}
button:disabled{opacity:.5;cursor:not-allowed}
.message{margin-top:12px;font-size:14px}
.error{color:#f87171}
.success{color:#4ade80}
.hidden{display:none}

/* modal */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;
  z-index:100;
}
.modal.show{display:flex}
.modal-card{
  background:#020617;
  border-radius:18px;
  padding:20px;
  max-width:320px;
  text-align:center;
}
</style>
</head>

<body>

<!-- Модалка -->
<div class="modal" id="modal">
  <div class="modal-card">
    <div id="modalText"></div>
    <button style="margin-top:14px" onclick="closeModal()">Закрыть</button>
  </div>
</div>

<!-- ШАГ EMAIL -->
<div class="card" id="emailStep">
  <div class="back-btn" onclick="goHome()">ВЕРНУТЬСЯ В ГЛАВНОЕ МЕНЮ</div>
  <h2>Подключение почты</h2>
  <div class="subtitle">Введите почту полностью</div>
  <input id="emailInput" placeholder="user@gmail.com">
  <button onclick="sendCode()">Отправить код</button>
  <div id="emailMsg" class="message"></div>
</div>

<!-- ШАГ КОД -->
<div class="card hidden" id="codeStep">
  <div class="back-btn" onclick="goHome()">ВЕРНУТЬСЯ В ГЛАВНОЕ МЕНЮ</div>
  <h2>Введите код</h2>
  <div class="subtitle" id="emailPreview"></div>
  <input id="codeInput" maxlength="6" placeholder="XXXXXX">
  <button onclick="verifyCode()">Подтвердить</button>
  <button class="secondary" id="resendBtn" onclick="resendCode()" disabled>
    Отправить повторно (30)
  </button>
  <button class="secondary" onclick="changeEmail()">Изменить почту</button>
  <div id="codeMsg" class="message"></div>
</div>

<script>
const GAS_URL =
'https://script.google.com/macros/s/AKfycbybbxKePXHLLcIlZ7ZrCx2L18X9sCPXGeX18AGYBlPP66lsre7wAcK3QY250w_nQ2bPcg/exec';

let userEmail = '';
let localCode = '';
let resendTimer = 30;
let timer = null;

const emailStep = document.getElementById('emailStep');
const codeStep  = document.getElementById('codeStep');
const emailMsg  = document.getElementById('emailMsg');
const codeMsg   = document.getElementById('codeMsg');
const emailPreview = document.getElementById('emailPreview');
const resendBtn = document.getElementById('resendBtn');

/* ───── Навигация ───── */
function goHome(){
  window.location.href = 'index.html';
}

/* ───── Модалка ───── */
function showModal(text){
  document.getElementById('modalText').textContent = text;
  document.getElementById('modal').classList.add('show');
}
function closeModal(){
  document.getElementById('modal').classList.remove('show');
}

/* ───── startapp проверка ───── */
async function checkStartApp(){
  const sp = Telegram?.WebApp?.initDataUnsafe?.start_param;
  if (!sp) return;

  try{
    const res = await fetch(GAS_URL + '?startapp=' + encodeURIComponent(sp));
    const json = await res.json();

    if (json.ok){
      localStorage.setItem('email', json.email);
      showModal('Почта успешно подтверждена');
      setTimeout(goHome, 1500);
    } else {
      showModal('Ошибка подтверждения: ' + json.error);
    }
  }catch{
    showModal('Ошибка соединения с сервером');
  }
}
checkStartApp();

/* ───── Отправка кода ───── */
function sendCode(){
  const email = emailInput.value.trim().toLowerCase();
  if (!email.includes('@')){
    emailMsg.textContent = 'Введите корректный email';
    emailMsg.className = 'message error';
    return;
  }

  userEmail = email;
  localCode = Math.floor(100000 + Math.random()*900000).toString();

  fetch(GAS_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ email:userEmail, code:localCode })
  });

  emailStep.classList.add('hidden');
  codeStep.classList.remove('hidden');
  emailPreview.textContent = userEmail;

  startTimer();
}

/* ───── Таймер повторной отправки ───── */
function startTimer(){
  resendTimer = 30;
  resendBtn.disabled = true;
  resendBtn.textContent = `Отправить повторно (${resendTimer})`;

  timer = setInterval(()=>{
    resendTimer--;
    resendBtn.textContent = `Отправить повторно (${resendTimer})`;
    if (resendTimer <= 0){
      clearInterval(timer);
      resendBtn.disabled = false;
      resendBtn.textContent = 'Отправить повторно';
    }
  },1000);
}

function resendCode(){
  localCode = Math.floor(100000 + Math.random()*900000).toString();
  fetch(GAS_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ email:userEmail, code:localCode })
  });
  startTimer();
}

/* ───── Проверка кода (UX) ───── */
function verifyCode(){
  if (codeInput.value.trim() === localCode){
    codeMsg.textContent = 'Код верный. Можно вернуться в бот';
    codeMsg.className = 'message success';
  } else {
    codeMsg.textContent = 'Неверный код';
    codeMsg.className = 'message error';
  }
}

function changeEmail(){
  clearInterval(timer);
  codeStep.classList.add('hidden');
  emailStep.classList.remove('hidden');
  codeInput.value = '';
  codeMsg.textContent = '';
}
</script>

</body>
</html>
